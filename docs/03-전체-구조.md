# 제3장 통합 아키텍처 전체 구조

> [← 이전: 제2장 설계 원칙](./02-설계-원칙.md) | [목차](./index.md) | [다음: 제4장 Core 레이어 →](./04-core-레이어.md)

---

## 3.1 디렉토리 구조 개관

통합 아키텍처의 전체 디렉토리 트리는 다음과 같다. **7개 레이어 폴더 + 1개 진입점**으로 구성되며, 총 약 18개 파일이다.

```
src/
│
├── core/                       # 기반 레이어
│   ├── __init__.py
│   ├── state.py                # State 정의 + Reducer
│   ├── schemas.py              # Pydantic I/O 모델
│   └── models.py               # LLM 설정 + 팩토리
│
├── memory/                     # 메모리 레이어
│   ├── __init__.py
│   ├── checkpointer.py         # 체크포인터 설정
│   └── store.py                # 영속 저장소 + 이력
│
├── prompts/                    # 프롬프트 레이어
│   ├── __init__.py
│   ├── templates.py            # 프롬프트 템플릿
│   └── builder.py              # 동적 조합 + 버전 관리
│
├── tools/                      # 도구 레이어
│   ├── __init__.py             # 레지스트리 + 내보내기
│   ├── base.py                 # 도구 베이스 클래스
│   ├── search.py               # 검색 도구
│   ├── calculator.py           # 계산기 도구
│   └── database.py             # DB 도구
│
├── nodes/                      # 노드 레이어
│   ├── __init__.py
│   ├── reasoning.py            # 추론/사고 노드
│   ├── execution.py            # 도구 실행 노드
│   └── routing.py              # 조건부 엣지 분기
│
├── graphs/                     # 그래프 레이어
│   ├── __init__.py
│   ├── builder.py              # 그래프 빌더 유틸
│   ├── researcher.py           # 리서처 서브그래프
│   ├── writer.py               # 라이터 서브그래프
│   └── main.py                 # 메인 그래프 조립
│
├── interfaces/                 # 인터페이스 레이어
│   ├── __init__.py
│   ├── api.py                  # REST 엔드포인트
│   └── stream.py               # 스트리밍 핸들러
│
├── config/                     # 설정
│   ├── settings.py             # 환경 변수, 전역 설정
│   └── agents.yaml             # 선언적 에이전트 구성
│
└── main.py                     # 실행 진입점
```

### 구조의 특징

| 특성 | 값 | 비고 |
|---|---|---|
| 레이어 폴더 수 | 7개 | core, memory, prompts, tools, nodes, graphs, interfaces + config |
| 총 파일 수 | ~18개 | `__init__.py` 포함 |
| 네스팅 깊이 | 1단계 | 폴더 내 하위 폴더 없음 |
| 진입점 | `main.py` | 루트 레벨 |

---

## 3.2 레이어 의존성 흐름

모든 레이어 간 의존은 **단방향 하향**으로만 흐른다. 이 규칙을 위반하면 순환 의존이 발생하여 유지보수가 급격히 어려워진다.

### 의존성 다이어그램

```
                 ┌──────────────┐
                 │   main.py    │  실행 진입점
                 └──────┬───────┘
                        │
                 ┌──────▼───────┐
                 │  interfaces/ │  API, 스트리밍
                 └──────┬───────┘
                        │
                 ┌──────▼───────┐
                 │   graphs/    │  그래프 조립
                 └──────┬───────┘
                        │
           ┌────────────┼────────────┐
           │            │            │
     ┌─────▼────┐ ┌─────▼────┐ ┌────▼─────┐
     │  nodes/  │ │ memory/  │ │ config/  │
     └─────┬────┘ └──────────┘ └──────────┘
           │
      ┌────┼──────────┐
      │    │          │
   ┌──▼────┐ ┌───────▼┐ ┌──────────┐
   │prompt/│ │ tools/ │ │  core/   │  ← 최하위 기반
   └───────┘ └────────┘ └──────────┘
```

### 의존 규칙

| 규칙 | 설명 |
|---|---|
| **화살표 방향만 import 허용** | 상위 레이어는 하위 레이어를 import할 수 있지만, 반대는 불가 |
| **core/는 자기 완결** | `core/`는 외부 레이어를 import하지 않는다. LangGraph, Pydantic 등 외부 라이브러리만 의존 |
| **순환 의존 해소** | 두 레이어가 서로를 필요로 하면, 공통 부분을 `core/`로 추출한다 |
| **config/는 수평 참조 허용** | `config/`는 특수하게, 여러 레이어에서 참조된다 (설정 주입 용도) |

### 레이어별 import 관계

```python
# core/ — 외부 의존 없음
from typing import TypedDict, Annotated
from langgraph.graph import add_messages

# memory/ — core에만 의존
from core.state import AgentState

# prompts/ — core에만 의존
from core.schemas import AgentRequest

# tools/ — core에만 의존
from core.schemas import ToolInput

# nodes/ — core, prompts, tools에 의존
from core.state import AgentState
from core.models import reasoning_model
from prompts.builder import build_prompt
from tools import get_tools

# graphs/ — nodes, memory, config에 의존
from nodes.reasoning import think
from nodes.routing import should_continue
from memory.checkpointer import get_checkpointer

# interfaces/ — graphs, core에 의존
from graphs.main import create_graph
from core.schemas import AgentRequest, AgentResponse

# main.py — interfaces에 의존
from interfaces.api import app
```

---

## 3.3 데이터 흐름도

사용자 요청이 시스템을 통과하는 전체 데이터 흐름을 추적한다.

### 요청 → 응답 흐름

```
사용자 요청
    │
    ▼
┌─────────────┐     ┌──────────────┐     ┌──────────────┐
│   api.py    │────▶│  main graph  │────▶│   think      │
│ (interface) │     │  (graphs/)   │     │ (reasoning)  │
└─────────────┘     └──────────────┘     └──────┬───────┘
                                                │
                                         ┌──────▼───────┐
                                         │  routing.py  │
                                         │should_continue│
                                         └──────┬───────┘
                              ┌──────────────┬───┴───────────┐
                              │              │               │
                       ┌──────▼───┐   ┌──────▼──┐   ┌───────▼───┐
                       │ execute  │   │ respond │   │ finalize  │
                       │ _tools   │   │  (END)  │   │           │
                       └──────┬───┘   └─────────┘   └───────┬───┘
                              │                              │
                              ▼                              ▼
                         think (루프)                       END
```

### 단계별 데이터 흐름

| 단계 | 컴포넌트 | 입력 | 처리 | 출력 |
|---|---|---|---|---|
| 1 | `api.py` | HTTP 요청 | 스키마 검증, State 초기화 | `AgentState` |
| 2 | `main graph` | `AgentState` | 그래프 실행 시작 | 첫 노드로 전달 |
| 3 | `reasoning.py` | State의 `messages` | LLM 호출, 계획 수립 | `messages` + `current_plan` 업데이트 |
| 4 | `routing.py` | State 전체 | 분기 판단 | `"execute_tools"` / `"respond"` / `"finalize"` |
| 5a | `execution.py` | State + 도구 호출 정보 | 도구 실행 | `messages`에 도구 결과 추가 → think로 루프 |
| 5b | 종료 | State | 최종 응답 추출 | `final_answer` |
| 6 | `stream.py` | 최종 State | SSE 포맷 변환 | 클라이언트에 스트리밍 전송 |

### State 변화 트레이스 예시

사용자가 "오늘 서울 날씨를 알려줘"라고 질문한 경우의 State 변화:

```
┌──────────┬──────────────────────────────────────────────┐
│  Step    │  State 변화                                   │
├──────────┼──────────────────────────────────────────────┤
│  START   │  messages: [HumanMessage("오늘 서울 날씨")]    │
│          │  context: []                                  │
│          │  current_plan: ""                             │
│          │  iteration: 0                                 │
├──────────┼──────────────────────────────────────────────┤
│  think   │  + messages: [AIMessage(tool_calls=[search])] │
│          │  + current_plan: "날씨 검색 필요"              │
│          │  + iteration: 1                               │
├──────────┼──────────────────────────────────────────────┤
│  route   │  → "execute_tools" (tool_calls 존재)          │
├──────────┼──────────────────────────────────────────────┤
│  execute │  + messages: [ToolMessage("서울 15°C, 맑음")] │
│          │  + context: ["서울 날씨: 15°C, 맑음"]          │
├──────────┼──────────────────────────────────────────────┤
│  think   │  + messages: [AIMessage("서울은 현재 15°C...")] │
│          │  + current_plan: "답변 가능"                   │
│          │  + iteration: 2                               │
├──────────┼──────────────────────────────────────────────┤
│  route   │  → "respond" (tool_calls 없음)                │
├──────────┼──────────────────────────────────────────────┤
│  END     │  final_answer: "서울은 현재 15°C..."           │
└──────────┴──────────────────────────────────────────────┘
```

---

## 3.4 아키텍처 정량 사양

본 아키텍처의 구조적 특성을 정량적으로 정리한다.

### 정량 사양

| 항목 | 값 | 비고 |
|---|---|---|
| 레이어 폴더 수 | 7개 | core, memory, prompts, tools, nodes, graphs, interfaces + config |
| 총 파일 수 | ~18개 | `__init__.py` 포함 |
| 네스팅 깊이 | 1단계 | 폴더 내 하위 폴더 없음 (Flat-First 원칙) |
| 필수 레이어 | 5개 | core, prompts, tools, nodes, graphs |
| 선택 레이어 | 3개 | memory, interfaces, config |
| 최소 시작 파일 수 | ~8개 | 필수 레이어만으로 동작 가능 |
| 프로덕션 완비 파일 수 | ~18개 | 전체 레이어 활성화 시 |

### 설계 목표

본 아키텍처는 **낮은 구조적 복잡도**와 **높은 확장성**을 동시에 달성하는 것을 목표로 한다. 이를 가능하게 하는 핵심 메커니즘은 **선택적 레이어**와 **평면 우선 구조**의 결합이다.

### 레이어별 특성 요약

| 레이어 | 파일 수 | 필수 여부 | 주요 관심사 |
|---|---|---|---|
| `core/` | 3 | 필수 | State, Schema, Model |
| `memory/` | 2 | 선택 | 체크포인팅, 영속 저장소 |
| `prompts/` | 2 | 필수 | 프롬프트 템플릿, 동적 조합 |
| `tools/` | 3+ | 필수 | 도구 정의, 레지스트리 |
| `nodes/` | 3 | 필수 | 추론, 실행, 라우팅 |
| `graphs/` | 3+ | 필수 | 그래프 조립, 서브그래프 |
| `interfaces/` | 2 | 선택 | API, 스트리밍 |
| `config/` | 2 | 선택 | 환경 설정, 에이전트 구성 |

---

> [← 이전: 제2장 설계 원칙](./02-설계-원칙.md) | [목차](./index.md) | [다음: 제4장 Core 레이어 →](./04-core-레이어.md)
